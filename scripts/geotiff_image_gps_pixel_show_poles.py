import rasterio
from rasterio.plot import reshape_as_image
import matplotlib.pyplot as plt
from pyproj import Transformer

def process_image(image_path, gps_points, output_path="../images/output.png", circle_radius=10, circle_color="red"):
    # Open the GeoTIFF image
    with rasterio.open(image_path) as src:
        # Read the image data
        image_data = src.read([1, 2, 3])  # Assuming a 3-band RGB image
        image_transform = src.transform
        crs = src.crs  # CRS of the GeoTIFF

        # Convert image data to RGB format
        rgb_image = reshape_as_image(image_data)

        # Create a matplotlib figure
        fig, ax = plt.subplots(figsize=(10, 10))
        ax.imshow(rgb_image)

        # Initialize the transformer if needed
        if not crs.is_geographic:
            transformer = Transformer.from_crs("EPSG:4326", crs.to_string(), always_xy=True)

        # Convert GPS points to the image's coordinate system and draw circles
        for lat, lon in gps_points:
            if crs.is_geographic:
                point_x, point_y = ~image_transform * (lon, lat)
            else:
                lon_proj, lat_proj = transformer.transform(lon, lat)
                point_x, point_y = ~image_transform * (lon_proj, lat_proj)

            # Draw a circle at the transformed coordinate
            circle = plt.Circle((point_x, point_y), radius=circle_radius, color=circle_color, fill=False, linewidth=2)
            ax.add_patch(circle)

        # Adjust axes to match the image
        ax.set_xlim(0, rgb_image.shape[1])  # Image width
        ax.set_ylim(rgb_image.shape[0], 0)  # Image height (inverted y-axis)
        ax.axis("off")

        # Save the image as a PNG
        plt.savefig(output_path, dpi=300, bbox_inches="tight", pad_inches=0)
        plt.close()

if __name__ == "__main__":
    image_path = "../images/39_feet/odm_orthophoto.tif"
    gps_points_poles = [
            (53.26818842,-0.52427737),
            (53.26813837,-0.52426541),
            (53.26808856,-0.52425335),
            (53.26803849,-0.52424047),
            (53.26818522,-0.52431449),
            (53.26813509,-0.52430208),
            (53.26808532,-0.52428968),
            (53.26803515,-0.52427742),
            (53.26818187,-0.52435181),
            (53.26813158,-0.52433952),
            (53.26808211,-0.52432693),
            (53.26803182,-0.52431475),
            (53.26817882,-0.52438866),
            (53.26812848,-0.52437636),
            (53.26807903,-0.52436409),
            (53.26802873,-0.52435185),
            (53.26817541,-0.52442589),
            (53.26812517,-0.5244135),
            (53.26807555,-0.5244011),
            (53.2680255,-0.52438878),
            (53.26817238,-0.52446323),
            (53.26812194,-0.52445077),
            (53.26807253,-0.52443819),
            (53.26802228,-0.52442619),
            (53.26816928,-0.52449965),
            (53.26811864,-0.52448766),
            (53.26806932,-0.52447579),
            (53.26801926,-0.52446331),
            (53.26816599,-0.52453691),
            (53.26811528,-0.5245244),
            (53.26806603,-0.52451219),
            (53.26801591,-0.52449999),
            (53.26816264,-0.52457417),
            (53.2681122,-0.52456217),
            (53.26806294,-0.52454963),
            (53.26801275,-0.52453719),
            (53.26815947,-0.52461139),
            (53.26810906,-0.52459885),
            (53.26805976,-0.52458653),
            (53.26800959,-0.52457471)
    ]
    process_image(image_path, gps_points_poles, output_path="../images/output_poles.png", circle_radius=10, circle_color="red")

    gps_points_vines = [
        (53.26818125, -0.52427621),
        (53.26817004, -0.52427306),
        (53.26815714, -0.52426999),
        (53.26814453, -0.52426726),
        (53.26813215, -0.52426415),
        (53.26811943, -0.52426123),
        (53.26810742, -0.52425824),
        (53.26809496, -0.52425490),
        (53.26808237, -0.52425189),
        (53.26807096, -0.52424852),
        (53.26805810, -0.52424554),
        (53.26804548, -0.52424226),
        (53.26817837, -0.52431294),
        (53.26816607, -0.52430953),
        (53.26815363, -0.52430700),
        (53.26814092, -0.52430412),
        (53.26812868, -0.52430140),
        (53.26811615, -0.52429742),
        (53.26810442, -0.52429494),
        (53.26809108, -0.52429101),
        (53.26807972, -0.52428885),
        (53.26806705, -0.52428593),
        (53.26805406, -0.52428257),
        (53.26804228, -0.52427934),
        (53.26817569, -0.52435058),
        (53.26816256, -0.52434704),
        (53.26815051, -0.52434437),
        (53.26813830, -0.52434119),
        (53.26812525, -0.52433792),
        (53.26811288, -0.52433503),
        (53.26810096, -0.52433186),
        (53.26808834, -0.52432898),
        (53.26807675, -0.52432620),
        (53.26806339, -0.52432300),
        (53.26805113, -0.52432041),
        (53.26803869, -0.52431687),
        (53.26817204, -0.52438719),
        (53.26816002, -0.52438441),
        (53.26814765, -0.52438178),
        (53.26813479, -0.52437842),
        (53.26812203, -0.52437544),
        (53.26810949, -0.52437205),
        (53.26809678, -0.52436903),
        (53.26808504, -0.52436666),
        (53.26807247, -0.52436297),
        (53.26806008, -0.52436015),
        (53.26804735, -0.52435675),
        (53.26803501, -0.52435344),
        (53.26816848, -0.52442444),
        (53.26815637, -0.52442172),
        (53.26814354, -0.52441819),
        (53.26813184, -0.52441517),
        (53.26811942, -0.52441227),
        (53.26810712, -0.52440931),
        (53.26809416, -0.52440618),
        (53.26808193, -0.52440316),
        (53.26806877, -0.52439988),
        (53.26805683, -0.52439723),
        (53.26804406, -0.52439410),
        (53.26803158, -0.52439133),
        (53.26816608, -0.52446148),
        (53.26815248, -0.52445841),
        (53.26814057, -0.52445555),
        (53.26812836, -0.52445214),
        (53.26811609, -0.52444942),
        (53.26810394, -0.52444666),
        (53.26809120, -0.52444319),
        (53.26807855, -0.52444050),
        (53.26806585, -0.52443674),
        (53.26805358, -0.52443424),
        (53.26804138, -0.52443130),
        (53.26802827, -0.52442744),
        (53.26816171, -0.52449858),
        (53.26814953, -0.52449527),
        (53.26813737, -0.52449231),
        (53.26812532, -0.52448937),
        (53.26811259, -0.52448694),
        (53.26810087, -0.52448363),
        (53.26808753, -0.52448088),
        (53.26807522, -0.52447800),
        (53.26806277, -0.52447461),
        (53.26805059, -0.52447188),
        (53.26803770, -0.52446818),
        (53.26802548, -0.52446547),
        (53.26815939, -0.52453531),
        (53.26814713, -0.52453308),
        (53.26813413, -0.52452989),
        (53.26812175, -0.52452684),
        (53.26810932, -0.52452391),
        (53.26809648, -0.52451990),
        (53.26808431, -0.52451693),
        (53.26807184, -0.52451406),
        (53.26805940, -0.52451096),
        (53.26804722, -0.52450811),
        (53.26803501, -0.52450570),
        (53.26802228, -0.52450247),
        (53.26815602, -0.52457312),
        (53.26814371, -0.52457008),
        (53.26813104, -0.52456747),
        (53.26811825, -0.52456409),
        (53.26810664, -0.52456098),
        (53.26809430, -0.52455805),
        (53.26808213, -0.52455499),
        (53.26806979, -0.52455249),
        (53.26805650, -0.52454852),
        (53.26804380, -0.52454563),
        (53.26803176, -0.52454321),
        (53.26801920, -0.52453973),
        (53.26815300, -0.52460990),
        (53.26813999, -0.52460809),
        (53.26812782, -0.52460473),
        (53.26811579, -0.52460162),
        (53.26810308, -0.52459813),
        (53.26809037, -0.52459534),
        (53.26807861, -0.52459240),
        (53.26806564, -0.52458895),
        (53.26805337, -0.52458564),
        (53.26804037, -0.52458268),
        (53.26802838, -0.52457973),
        (53.26801692, -0.52457647)
    ]
    process_image(image_path, gps_points_vines, output_path="../images/output_vines.png", circle_radius=10, circle_color="blue")